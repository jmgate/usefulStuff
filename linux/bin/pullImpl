#!/bin/bash
showHelp=false
all=false
usual=false
fork=false
trilinos=false
drekarBase=false
drekarSystemTests=false
drekarDocuments=false
charon=false
charonData=false
charonOuoData=false
noTrilinos=false
noDrekarBase=false
noDrekarResearch=false
noDrekarSystemTests=false
noDrekarDocuments=false
noCharon=false
noCharonData=false
noCharonOuoData=false
ask=true
if [[ $# -gt 0 ]]; then
  ask=false
fi
while [[ $# -gt 0 ]]
do
  key="$1"
  case $key in
    -h   |--help                  ) showHelp=true              ;;
    -a   |--all                   ) all=true                   ;;
    -u   |--usual                 ) usual=true                 ;;
    -f   |--fork                  ) fork=true                  ;;
    -t   |--trilinos              ) trilinos=true              ;;
    -db  |--drekar-base           ) drekarBase=true            ;;
    -dst |--drekar-system-tests   ) drekarSystemTests=true     ;;
    -dd  |--drekar-documents      ) drekarDocuments=true       ;;
    -c   |--charon                ) charon=true                ;;
    -cd  |--charon-data           ) charonData=true            ;;
    -cod |--charon-ouo-data       ) charonOuoData=true         ;;
    -nt  |--no-trilinos           ) noTrilinos=true            ;;
    -ndb |--no-drekar-base        ) noDrekarBase=true          ;;
    -ndr |--no-drekar-research    ) noDrekarResearch=true      ;;
    -ndst|--no-drekar-system-tests) noDrekarSystemTests=true   ;;
    -ndd |--no-drekar-documents   ) noDrekarDocuments=true     ;;
    -nc  |--no-charon             ) noCharon=true              ;;
    -ncd |--no-charon-data        ) noCharonData=true          ;;
    -ncod|--no-charon-ouo-data    ) noCharonOuoData=true       ;;
    *)
      echo "Unrecognized option:  $key"
      showHelp=true
      ;;
  esac
  shift
done
if $all; then
  trilinos=true
  drekarBase=true
  drekarSystemTests=true
  drekarDocuments=true
  charon=true
  charonData=true
  charonOuoData=true
fi
if $usual; then
  trilinos=true
  drekarBase=true
  charon=true
fi
if $noTrilinos;          then trilinos=false;          fi
if $noDrekarBase;        then drekarBase=false;        fi
if $noDrekarSystemTests; then drekarSystemTests=false; fi
if $noDrekarDocuments;   then drekarDocuments=false;   fi
if $noCharon;            then charon=false;            fi
if $noCharonData;        then charonData=false;        fi
if $noCharonOuoData;     then charonOuoData=false;     fi
if $showHelp; then
  echo "┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓"
  echo "┃ This script will issue a 'git pull' in the following repositories:          ┃"
  echo "┃   Trilinos      DrekarSystemTests    tcad-charon    charon-ouo-data         ┃"
  echo "┃   DrekarBase    DrekarDocuments      charon-data                            ┃"
  echo "┠─────────────────────────────────────────────────────────────────────────────┨"
  echo "┃ Usage:  pull [options]                                                      ┃"
  echo "┃   With no options specified, you will be asked before pulling each          ┃"
  echo "┃   repository.  The available options are:                                   ┃"
  echo "┃     -h, --help:   Display this help message.                                ┃"
  echo "┃     -a, --all:    Pull all repositories.                                    ┃"
  echo "┃     -u, --usual:  Pull Trilinos, DrekarBase, and tcad-charon.               ┃"
  echo "┃     -f, --fork:   Pull from the jmgate/Trilinos fork instead of from        ┃"
  echo "┃                   trilinos/Trilinos.                                        ┃"
  echo "┃   The options below will pull the corresponding repositories:               ┃"
  echo "┃     -t,    --trilinos                                                       ┃"
  echo "┃     -db,   --drekar-base                                                    ┃"
  echo "┃     -dst,  --drekar-system-tests                                            ┃"
  echo "┃     -dd,   --drekar-documents                                               ┃"
  echo "┃     -c,    --charon                                                         ┃"
  echo "┃     -cd,   --charon-data                                                    ┃"
  echo "┃     -cod,  --charon-ouo-data                                                ┃"
  echo "┃   The options below will prevent pulling the corresponding repositories     ┃"
  echo "┃     (to use in conjunction with --all, for instance):                       ┃"
  echo "┃     -nt,   --no-trilinos                                                    ┃"
  echo "┃     -ndb,  --no-drekar-base                                                 ┃"
  echo "┃     -ndst, --no-drekar-system-tests                                         ┃"
  echo "┃     -ndd,  --no-drekar-documents                                            ┃"
  echo "┃     -nc,   --no-charon                                                      ┃"
  echo "┃     -ncd,  --no-charon-data                                                 ┃"
  echo "┃     -ncod, --no-charon-ouo-data                                             ┃"
  echo "┃   The options in the group above take precedence; that is, running          ┃"
  echo "┃   'pull -t -nt', for instance, will result in nothing happening.            ┃"
  echo "┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛"
  exit 0
fi
pullRepo()
{
  echo
  response=n
  if $1; then
    response=y
  fi
  if $ask; then
    read -r -p "Would you like to pull $2? [Y/n] " response
  fi
  if [[ -z "$response" || $response =~ ([Yy][Ee][Ss]|[Yy])$ ]]; then
    cd $3
    banner "Pulling $2"
    if [ "$2" == "DrekarSystemTests" ] || [ "$2" == "DrekarDocuments" ]; then
      svn update
    else
      git pull
    fi
  elif [[ $response =~ ([Nn][Oo]|[Nn])$ ]]; then
    banner "Skipping $2"
  fi
}
if $fork; then
  pullRepo $trilinos          "Trilinos"          $FORKED_TRILINOS_DIR
  pullRepo $drekarBase        "DrekarBase"        $FORKED_DREKAR_BASE_DIR
  pullRepo $drekarSystemTests "DrekarSystemTests" $DREKAR_SYSTEM_TESTS_DIR
  pullRepo $drekarDocuments   "DrekarDocuments"   $DREKAR_DOCS_DIR
  pullRepo $charon            "tcad-charon"       $FORKED_CHARON_DIR
  pullRepo $charonData        "charon-data"       $FORKED_CHARON_DATA_DIR
  pullRepo $charonOuoData     "charon-ouo-data"   $FORKED_CHARON_OUO_DATA_DIR
else
  pullRepo $trilinos          "Trilinos"          $TRILINOS_DIR
  pullRepo $drekarBase        "DrekarBase"        $DREKAR_BASE_DIR
  pullRepo $drekarSystemTests "DrekarSystemTests" $DREKAR_SYSTEM_TESTS_DIR
  pullRepo $drekarDocuments   "DrekarDocuments"   $DREKAR_DOCS_DIR
  pullRepo $charon            "tcad-charon"       $CHARON_DIR
  pullRepo $charonData        "charon-data"       $CHARON_DATA_DIR
  pullRepo $charonOuoData     "charon-ouo-data"   $CHARON_OUO_DATA_DIR
fi
